from datetime import date

from src.service.gsec.util.ytm_calculator import calculate_gsec_ytm

# Test cases: symbol -> (price, coupon_rate, maturity_date, is_tbill, is_stripped_gsec, face_value, expected_ytm)
test_cases = {
    "833GS2026": (103, 8.33, date(2026, 3, 31), False, False, 100, 2.2621359223300956),
    "717GS2030": (
        103.85,
        7.17,
        date(2030, 3, 31),
        False,
        False,
        100,
        6.176974294619162,
    ),
    "717GS2028": (103.2, 7.17, date(2028, 3, 31), False, False, 100, 5.776977142803263),
    "664GS2027": (103.4, 6.64, date(2027, 3, 31), False, False, 100, 4.27573339038385),
    "86GS2028": (108.4, 8.6, date(2028, 3, 31), False, False, 100, 4.984651559154437),
    "675GS2029": (112, 6.75, date(2029, 3, 31), False, False, 100, 3.105219334805072),
    "601GS2028": (
        103.95,
        6.01,
        date(2028, 3, 31),
        False,
        False,
        100,
        4.326011152844194,
    ),
    "759GS2026": (
        106.5,
        7.59,
        date(2026, 3, 31),
        False,
        False,
        100,
        -5.079812206572693,
    ),
    "697GS2026": (
        103.69,
        6.97,
        date(2026, 3, 31),
        False,
        False,
        100,
        -0.395409393384111,
    ),
    "679GS2027": (
        100.85,
        6.79,
        date(2027, 3, 31),
        False,
        False,
        100,
        6.187912402814518,
    ),
    "574GS2026": (99.8, 5.74, date(2026, 3, 31), False, False, 100, 6.1523046092184694),
    "826GS2027": (
        105.95,
        8.26,
        date(2027, 3, 31),
        False,
        False,
        100,
        4.128455988114131,
    ),
    "701MH32": (100, 7.01, date(2032, 3, 31), False, False, 100, 7.009999999999988),
    "74CG30": (101.54, 7.4, date(2030, 3, 31), False, False, 100, 6.99519117523606),
    "738GS2027": (
        105.69,
        7.38,
        date(2027, 3, 31),
        False,
        False,
        100,
        3.4548640129011114,
    ),
    "699GS2026": (99.27, 6.99, date(2026, 3, 31), False, False, 100, 8.512138611866613),
    "591GS2028": (101.6, 5.91, date(2028, 3, 31), False, False, 100, 5.219037043176066),
    "710GS2029": (103.32, 7.1, date(2029, 3, 31), False, False, 100, 6.033563645418974),
    "759GS2029": (
        103.97,
        7.59,
        date(2029, 3, 31),
        False,
        False,
        100,
        6.308168600336157,
    ),
    "761GS2030": (
        106.65,
        7.61,
        date(2030, 3, 31),
        False,
        False,
        100,
        5.905587895267867,
    ),
    "704GS2029": (102.8, 7.04, date(2029, 3, 31), False, False, 100, 6.138811812229324),
    "744AP36": (101.9, 7.44, date(2036, 3, 31), False, False, 100, 7.179273175907867),
    "763GS2059": (
        103.51,
        7.63,
        date(2059, 3, 31),
        False,
        False,
        100,
        7.346875012355714,
    ),
    "716GS2050": (104.75, 7.16, date(2050, 3, 31), False, False, 100, 6.76052362224973),
    "767WB37": (101, 7.67, date(2037, 12, 21), False, False, 100, 7.545035776366829),
    "883GS2041": (
        118.65,
        8.83,
        date(2041, 3, 31),
        False,
        False,
        100,
        6.857405508225231,
    ),
    "667GS2050": (96.85, 6.67, date(2050, 3, 31), False, False, 100, 6.939195347059279),
    "695GS2061": (95, 6.95, date(2061, 3, 31), False, False, 100, 7.348128011977499),
    # Stripped GSEC
    "GS220261P": (5.69, 0, date(2061, 2, 22), False, True, 100, 8.47723919709682),
    "GS150626C": (77.55, 0, date(2026, 6, 15), False, True, 100, 64.25634353302634),
    "GS231225C": (78.23, 0, date(2025, 12, 23), False, True, 100, 98470.91877922635),
    "GS090326C": (77, 0, date(2026, 3, 9), False, True, 100, 192.0892444391792),
    "GS100526C": (76, 0, date(2026, 5, 10), False, True, 100, 94.1331023340567),
    "GS220840C": (26.39, 0, date(2040, 8, 22), False, True, 100, 9.479349328905528),
    "GS220236C": (37.1, 0, date(2036, 2, 22), False, True, 100, 10.20067432769627),
    "GS020126C": (78.09, 0, date(2026, 1, 2), False, True, 100, 4963.653060556844),
    "GS220226C": (77.28, 0, date(2026, 2, 22), False, True, 100, 256.5343681818166),
    # TBills
    "364D220126": (97.9, 0, date(2026, 1, 22), True, False, 100, 18.2079483098558),
    "364D040626": (96.02, 0, date(2026, 6, 4), True, False, 100, 8.59610213781221),
    "182D111225": (99.4, 0, date(2025, 12, 11), True, False, 100, 220.321931589535),
    "364D261126": (94.77, 0, date(2026, 11, 26), True, False, 100, 5.73874009560409),
    "91D050326": (98.6, 0, date(2026, 3, 5), True, False, 100, 6.09712444815657),
    "364D061126": (94.85, 0, date(2026, 11, 6), True, False, 100, 5.98735163009809),
    "364D140526": (97.45, 0, date(2026, 5, 14), True, False, 100, 6.16196891706251),
    "182D010126": (99.45, 0, date(2026, 1, 1), True, False, 100, 9.17546505781795),
    "91D111225": (99.75, 0, date(2025, 12, 11), True, False, 100, 91.4786967418546),
    "91D181225": (99.69, 0, date(2025, 12, 18), True, False, 100, 14.1877319691043),
}

for symbol, (
    price,
    coupon_rate,
    maturity_date,
    is_tbill,
    is_stripped_gsec,
    face_value,
    expected,
) in test_cases.items():
    result = calculate_gsec_ytm(
        price=price,
        coupon_rate=coupon_rate,
        maturity_date=maturity_date,
        settlement_date=date(2025, 12, 10),
        is_tbill=is_tbill,
        is_stripped_gsec=is_stripped_gsec,
        face_value=face_value,
        coupon_frequency=2,
    )

    TOL = 0.00001
    assert (
        abs(result - expected) <= TOL
    ), f"FAILED for {symbol}: expected {expected}, got {result}"
